<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Human Maturography Records</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container py-3">
    <h3 class="text-center mb-4 text-primary">Unified Human Maturography Records</h3>

      <div class="table-responsive table-responsive-scroll scale-wrapper">
      {{ table_html|safe }}
    </div>    <div class="btn-group mt-4 flex-wrap justify-content-center">
      <a href="/download" class="btn btn-success">ğŸ“Š Download as Excel</a>
      <button id="undo-latest-btn" class="btn btn-info">â†©ï¸ Undo (<span id="undo-count">0</span>)</button>
      <button id="clear-cache-btn" class="btn btn-warning">ğŸ§¹ Clear All (cache)</button>
      <button id="clear-all-remote-btn" class="btn btn-danger">ğŸ§¨ Clear All (cache + remote)</button>
      <a href="/" class="btn btn-outline-secondary">ğŸ  Back to Calculator</a>
      <a href="/logout" class="btn btn-danger">ğŸ”“ Logout</a>
    </div>

    <div class="zoom-controls">
      <button onclick="zoomContent(1.2)">â•</button>
      <button onclick="zoomContent(0.8)">â–</button>
      <button onclick="resetZoom()">Reset</button>
    </div>
  </div>

  <script>
    const contentWrapper = document.querySelector('.scale-wrapper');
    let scale = 1;

    // Update undo button count
    function updateUndoCount() {
      fetch('/admin/undo_list').then(r => r.json()).then(res => {
        document.getElementById('undo-count').textContent = res.count || 0;
        const undoBtn = document.getElementById('undo-latest-btn');
        if (res.count > 0) {
          undoBtn.disabled = false;
        } else {
          undoBtn.disabled = true;
        }
      });
    }

    // Initialize undo count on page load
    updateUndoCount();

    function zoomContent(factor) {
      scale *= factor;
      contentWrapper.style.transform = `scale(${scale})`;
      contentWrapper.style.transformOrigin = 'top left';
    }

    function resetZoom() {
      scale = 1;
      contentWrapper.style.transform = 'scale(1)';
    }

    // Attach delete handlers for dynamically generated Delete buttons
    document.addEventListener('click', function(e) {
      if (e.target && e.target.classList.contains('delete-row')) {
        const cachedAt = e.target.getAttribute('data-cached-at');
        if (!confirm('Delete this record from cache?')) return;
        fetch('/admin/delete_row', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cached_at: cachedAt })
        }).then(r => r.json()).then(res => {
          if (res.success) {
            updateUndoCount();
            location.reload();
          } else {
            alert('Delete failed: ' + (res.error || 'unknown'));
          }
        }).catch(err => alert('Delete failed: ' + err));
      }
    });

    // Undo latest deletion
    const undoBtn = document.getElementById('undo-latest-btn');
    if (undoBtn) {
      undoBtn.addEventListener('click', function() {
        if (!confirm('Restore the most recently deleted record?')) return;
        fetch('/admin/undo_latest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        }).then(r => r.json()).then(res => {
          if (res.success) {
            updateUndoCount();
            location.reload();
          } else {
            alert('Undo failed: ' + (res.error || 'unknown'));
          }
        }).catch(err => alert('Undo failed: ' + err));
      });
    }

    // Clear cache (local only)
    const clearBtn = document.getElementById('clear-cache-btn');
    if (clearBtn) {
      clearBtn.addEventListener('click', function() {
        if (!confirm('Clear all cached records? This removes the local cached copy only.')) return;
        fetch('/admin/clear_all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ delete_remote: false })
        }).then(r => r.json()).then(res => {
          if (res.success) location.reload(); else alert('Clear failed: ' + (res.error || 'unknown'));
        }).catch(err => alert('Clear failed: ' + err));
      });
    }

    // Clear cache + remote
    const clearRemoteBtn = document.getElementById('clear-all-remote-btn');
    if (clearRemoteBtn) {
      clearRemoteBtn.addEventListener('click', function() {
        if (!confirm('This will remove all cached records AND delete all records from the remote database. Are you sure?')) return;
        fetch('/admin/clear_all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ delete_remote: true })
        }).then(r => r.json()).then(res => {
          if (res.success) location.reload(); else alert('Clear+Remote failed: ' + (res.error || 'unknown'));
        }).catch(err => alert('Clear+Remote failed: ' + err));
      });
    }
  </script>
</body>
</html>
